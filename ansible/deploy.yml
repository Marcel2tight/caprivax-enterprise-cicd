---
- name: Enterprise SmartOps Deployment
  hosts: all
  become: yes
  serial: 1  

  vars:
    nexus_ip: "10.128.0.7"
    
    # FIX: Match the groupId from your pom.xml (com.smartops)
    group_id_path: "com/smartops"
    artifact_id: "smartops-backend"
    
    # Match the packaging type from your build
    extension: "war"
    
    app_dest: "/opt/smartops-api.{{ extension }}"

  tasks:
    - name: ðŸ“¦ Download Artifact from Nexus
      get_url:
        url: "http://{{ nexus_ip }}:8081/repository/java-webapp-releases/{{ group_id_path }}/{{ artifact_id }}/{{ app_version }}/{{ artifact_id }}-{{ app_version }}.{{ extension }}"
        dest: "{{ app_dest }}"
        url_username: admin
        url_password: "{{ nexus_pwd }}"
        mode: '0755'
        # Important: Ensure basic auth is forced for Nexus
        force_basic_auth: yes

    - name: ðŸš€ Restart SmartOps Service
      systemd:
        name: smartops
        state: restarted
        daemon_reload: yes
        enabled: yes
