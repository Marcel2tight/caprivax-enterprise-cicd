---
- name: Enterprise SmartOps Deployment
  hosts: all
  become: yes
  serial: 1

  vars:
    # NETWORK CONFIG
    nexus_ip: "10.128.0.7" 

    # PROJECT IDENTITY
    group_id_path: "com/caprivax"
    artifact_id: "smartops-backend"
    # We change this to war to match your pom.xml packaging
    extension: "war"

    # TARGET CONFIG
    app_dest: "/opt/smartops-api.{{ extension }}"

  tasks:
    - name: üì¶ Download Artifact from Nexus
      get_url:
        url: "http://{{ nexus_ip }}:8081/repository/java-webapp-releases/{{ group_id_path }}/{{ artifact_id }}/{{ app_version }}/{{ artifact_id }}-{{ app_version }}.{{ extension }}"
        dest: "{{ app_dest }}"
        url_username: admin
        url_password: "{{ nexus_pwd }}"
        mode: '0755'

    - name: ‚öôÔ∏è Configure Systemd Service
      copy:
        dest: /etc/systemd/system/smartops.service
        content: |
          [Unit]
          Description=Caprivax SmartOps API
          After=network.target

          [Service]
          User=marce
          # Java can execute .war files directly with the -jar flag if they are executable
          ExecStart=/usr/bin/java -jar {{ app_dest }}
          SuccessExitStatus=143
          Restart=always

          [Install]
          WantedBy=multi-user.target

    - name: üöÄ Reload Systemd and Restart Service
      systemd:
        name: smartops
        state: restarted
        daemon_reload: yes
        enabled: yes
