---
- name: Enterprise SmartOps Deployment
  hosts: all
  become: yes
  vars:
    # NETWORK CONFIG
    nexus_ip: "10.128.0.7"  # Using Internal IP for stability

    # PROJECT IDENTITY (Must match your pom.xml exactly)
    group_id_path: "com/caprivax"
    artifact_id: "smartops-backend"

    # TARGET CONFIG
    app_dest: "/opt/smartops-api.jar"

  tasks:
    - name: üì¶ Download Artifact from Nexus
      get_url:
        url: "http://{{ nexus_ip }}:8081/repository/java-webapp-releases/{{ group_id_path }}/{{ artifact_id }}/{{ app_version }}/{{ artifact_id }}-{{ app_version }}.jar"
        dest: "{{ app_dest }}"
        url_username: admin
        url_password: "{{ nexus_pwd }}"
        mode: '0755'

    - name: ‚öôÔ∏è Configure Systemd Service
      copy:
        dest: /etc/systemd/system/smartops.service
        content: |
          [Unit]
          Description=Caprivax SmartOps API
          After=network.target

          [Service]
          User=marce
          # Executing the jar we just downloaded
          ExecStart=/usr/bin/java -jar {{ app_dest }}
          SuccessExitStatus=143
          Restart=always

          [Install]
          WantedBy=multi-user.target

    - name: üöÄ Reload Systemd and Restart Service
      systemd:
        name: smartops
        state: restarted
        daemon_reload: yes
        enabled: yes
